name: App CI/CD
on:
  push:
    paths:
      - 'app/**'

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
    steps:
    - uses: actions/checkout@v4
    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v3
      with:
        role-to-assume: arn:aws:iam::253490792199:role/github-oidc-deploy-role
        aws-region: us-east-1
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    - name: Login to ECR
      uses: aws-actions/amazon-ecr-login@v2
      with:
        region: us-east-1
    - name: Ensure ECR repository
      run: |
        set -e
        # Determine ECR repo name: prefer secret, fall back to default
        if [ -z "${{ secrets.ECR_REPO }}" ]; then
          echo "ECR_REPO will default to 'wiz-tasky'"
          echo "ECR_REPO=wiz-tasky" >> $GITHUB_ENV
        else
          echo "ECR_REPO=${{ secrets.ECR_REPO }}" >> $GITHUB_ENV
        fi

        # Determine account ID and registry
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        echo "ECR_REGISTRY=${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com" >> $GITHUB_ENV

        # Create repo if missing
        aws ecr describe-repositories --repository-names "${ECR_REPO}" || aws ecr create-repository --repository-name "${ECR_REPO}"
    - name: Build image
      run: |
        docker build -t ${ECR_REPO}:latest ./app
        docker tag ${ECR_REPO}:latest ${ECR_REGISTRY}/${ECR_REPO}:latest
    - name: Scan image
      run: trivy image --severity HIGH,CRITICAL ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPO }}:latest || true
    - name: Push image
      run: docker push ${ECR_REGISTRY}/${ECR_REPO}:latest
    - name: Trigger K8s rollout
      run: |
        # uses kubectl with KUBECONFIG from secrets or from Terraform outputs
        kubectl set image deployment/tasky-app tasky=${ECR_REGISTRY}/${ECR_REPO}:latest

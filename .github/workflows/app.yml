name: App CI/CD
on:
  push:
    paths:
      - 'app/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v3
      with:
        role-to-assume: arn:aws:iam::253490792199:role/github-oidc-deploy-role
        aws-region: us-east-1
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    - name: Login to ECR
      uses: aws-actions/amazon-ecr-login@v2
      with:
        region: us-east-1
    - name: Ensure ECR repository
      env:
        ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
        ECR_REPO: ${{ secrets.ECR_REPO }}
      run: |
        set -e
        if [[ -z "${ECR_REGISTRY}" || -z "${ECR_REPO}" ]]; then
          echo "ECR_REGISTRY and ECR_REPO secrets must be set" >&2
          exit 1
        fi
        # Create repo if missing
        aws ecr describe-repositories --repository-names "${ECR_REPO}" || aws ecr create-repository --repository-name "${ECR_REPO}"
    - name: Build image
      run: |
        docker build -t ${{ secrets.ECR_REPO }}:latest ./app
        docker tag ${{ secrets.ECR_REPO }}:latest ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPO }}:latest
    - name: Scan image
      run: trivy image --severity HIGH,CRITICAL ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPO }}:latest || true
    - name: Push image
      run: docker push ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPO }}:latest
    - name: Trigger K8s rollout
      run: |
        # uses kubectl with KUBECONFIG from secrets or from Terraform outputs
        kubectl set image deployment/tasky-app tasky=${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPO }}:latest

name: App CI/CD
on:
  push:
    paths:
      - 'app/**'

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
    steps:
    - uses: actions/checkout@v4
    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v3
      with:
        role-to-assume: arn:aws:iam::253490792199:role/github-oidc-deploy-role
        aws-region: us-east-1
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    - name: Login to ECR
      uses: aws-actions/amazon-ecr-login@v2
      with:
        region: us-east-1
    - name: Ensure ECR repository
      run: |
        set -e
        # Determine ECR repo name: prefer secret, fall back to default
        if [ -z "${{ secrets.ECR_REPO }}" ]; then
          REPO_NAME="wiz-tasky"
          echo "ECR_REPO will default to 'wiz-tasky'"
        else
          REPO_NAME="${{ secrets.ECR_REPO }}"
        fi

        # Export for subsequent steps
        echo "ECR_REPO=${REPO_NAME}" >> $GITHUB_ENV

        # Determine account ID and registry and export
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        REGISTRY="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        echo "ECR_REGISTRY=${REGISTRY}" >> $GITHUB_ENV

        # Create repo if missing (use local variable)
        aws ecr describe-repositories --repository-names "${REPO_NAME}" || aws ecr create-repository --repository-name "${REPO_NAME}"
    - name: Build image
      run: |
        docker build -t ${ECR_REPO}:latest ./app
        docker tag ${ECR_REPO}:latest ${ECR_REGISTRY}/${ECR_REPO}:latest
    - name: Scan image
      run: trivy image --severity HIGH,CRITICAL ${ECR_REGISTRY}/${ECR_REPO}:latest || true
    - name: Push image
      run: docker push ${ECR_REGISTRY}/${ECR_REPO}:latest
    - name: Configure kubectl for EKS (optional)
      run: |
        # If you set the EKS_CLUSTER_NAME secret, this will configure kubeconfig for kubectl
        if [ -z "${{ secrets.EKS_CLUSTER_NAME }}" ]; then
          echo "EKS_CLUSTER_NAME secret not set; skipping aws eks update-kubeconfig"
          exit 0
        fi
        aws eks update-kubeconfig --name "${{ secrets.EKS_CLUSTER_NAME }}" --region "${{ env.AWS_REGION }}"
    - name: Trigger K8s rollout
      run: |
        # Only run kubectl if kubeconfig exists (either from aws eks update-kubeconfig or provided secret)
        if [ -f "$HOME/.kube/config" ]; then
          echo "Kubeconfig found, updating deployment image"
          kubectl set image deployment/tasky-app tasky=${ECR_REGISTRY}/${ECR_REPO}:latest
        else
          echo "Kubeconfig not found; skipping kubectl set image to avoid connection errors"
        fi

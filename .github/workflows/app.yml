name: App CI/CD

on:
  push:
    paths:
      - 'app/**'
      - 'k8s/**'
      - 'helm/**'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ECR_REPO: wiz-tasky
  EKS_CLUSTER_NAME: wiz-exercise-eks

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run npm audit
        working-directory: ./app
        run: npm audit --audit-level=moderate || true
      
      - name: Build image for scanning
        run: docker build -t scan-image:latest ./app
      
      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'scan-image:latest'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

  build-and-deploy:
    name: Build and Deploy
    needs: security-scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::253490792199:role/github-oidc-deploy-role
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Get ECR registry
        id: ecr
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REGISTRY="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          echo "registry=${REGISTRY}" >> $GITHUB_OUTPUT
          aws ecr describe-repositories --repository-names "${ECR_REPO}" 2>/dev/null || \
            aws ecr create-repository --repository-name "${ECR_REPO}"
      
      - name: Build and push image
        env:
          ECR_REGISTRY: ${{ steps.ecr.outputs.registry }}
        run: |
          docker build -t ${ECR_REGISTRY}/${ECR_REPO}:latest ./app
          docker push ${ECR_REGISTRY}/${ECR_REPO}:latest
      
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
      
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      
      - name: Configure kubectl
        if: ${{ env.EKS_CLUSTER_NAME != '' }}
        run: |
          aws eks update-kubeconfig --name "${EKS_CLUSTER_NAME}" --region "${AWS_REGION}"
      
      - name: Deploy to Kubernetes
        if: ${{ env.EKS_CLUSTER_NAME != '' }}
        env:
          ECR_REGISTRY: ${{ steps.ecr.outputs.registry }}
        run: |
          export IMAGE="${ECR_REGISTRY}/${ECR_REPO}:latest"
          ./scripts/deploy.sh

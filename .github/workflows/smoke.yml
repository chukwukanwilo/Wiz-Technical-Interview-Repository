name: Smoke tests

on:
  workflow_dispatch: {}

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
        kubectl version --client
    - name: Setup Kubeconfig from secret
      run: |
        if [ -z "${{ secrets.KUBECONFIG }}" ]; then
          echo "KUBECONFIG secret is missing; please add a base64-encoded kubeconfig to the repository secret KUBECONFIG" >&2
          exit 1
        fi
        echo "Writing kubeconfig"
        echo "${{ secrets.KUBECONFIG }}" | base64 --decode > $HOME/.kube/config
        chmod 600 $HOME/.kube/config
    - name: Run smoke tests
      env:
        KUBECONFIG: $HOME/.kube/config
      run: |
        chmod +x ./scripts/smoke_test.sh
        ./scripts/smoke_test.sh
    - name: Upload smoke logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: smoke-logs
        path: ./kubeconfig
